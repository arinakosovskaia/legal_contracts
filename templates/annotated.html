<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Annotated View — Contract Red-Flag Detector</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg: #0a0a0a;
        --ink: #fafafa;
        --muted: #a1a1aa;
        --card: #141414;
        --border: #27272a;
        --radius: 12px;
        --radius-lg: 16px;
        --shadow: 0 4px 24px rgba(0, 0, 0, 0.35);
        --gradient-btn: linear-gradient(135deg, #22c55e 0%, #06b6d4 50%, #0ea5e9 100%);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "DM Sans", system-ui, -apple-system, sans-serif;
        background: var(--bg);
        color: var(--ink);
        font-size: 15px;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
      }
      .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow);
      }
      h2 { font-size: 1.5rem; font-weight: 600; margin: 0 0 0.5rem; letter-spacing: -0.02em; }
      .muted { color: var(--muted); }
      .split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
      .doc { max-height: 80vh; overflow: auto; font-size: 14px; line-height: 1.55; border-radius: var(--radius); }
      .para { margin-bottom: 12px; padding: 10px 12px; border-radius: var(--radius); transition: background 0.2s ease; }
      .para:hover { background: rgba(255,255,255,0.04); }
      .hl { background: rgba(250, 204, 21, 0.4); border-radius: 4px; padding: 0 2px; cursor: pointer; text-decoration: underline; transition: background 0.2s ease; }
      .hl:hover { background: rgba(250, 204, 21, 0.6); }
      .hl.active { background: rgba(251, 191, 36, 0.7); border: 2px solid #f59e0b; }
      .btn {
        padding: 10px 18px;
        background: var(--gradient-btn);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        font-family: inherit;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .btn:hover { opacity: 0.95; transform: translateY(-1px); }
      .detail-field { margin-bottom: 16px; font-size: 14px; line-height: 1.55; }
      .detail-field .label { font-weight: 600; margin-bottom: 6px; font-size: 13px; color: var(--muted); }
      .detail-field .value,
      .detail-field div,
      .detail-field pre,
      .detail-field ul { color: var(--ink); font-family: inherit; }
      .detail-field pre { white-space: pre-wrap; margin: 0; }
      .back-link:hover { color: var(--ink); }
      .ai-disclaimer {
        text-align: center;
        padding: 16px 24px 24px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.5;
      }
      @media (max-width: 980px) {
        .split { grid-template-columns: 1fr; }
        .doc { max-height: none; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div style="margin-bottom: 16px;">
        <a href="/" class="back-link" style="color: var(--muted); font-size: 14px; text-decoration: none; transition: color 0.2s ease;">← Back to Contract Red-Flag Detector</a>
      </div>
      <div class="card">
        <h2>Detailed explanation of unfair clauses</h2>
        <p class="muted" style="margin-top: 8px; margin-bottom: 16px;">Click on a highlighted clause to view detailed analysis.</p>
        <p id="status" class="muted" style="margin-top: 0;">Loading…</p>
        <div style="margin-bottom: 12px;">
          <button id="nextClauseBtn" class="btn" style="display:none; padding: 8px 16px; background: #3b82f6; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Next unfair clause →</button>
        </div>
        <div class="split">
          <div class="card doc" id="docBox"></div>
          <div class="card" id="detailBox">
            <div class="muted">Click a highlighted clause to view details.</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function getJobId() {
        const m = window.location.pathname.match(/\/job\/([^/]+)\/annotated/);
        if (m && m[1]) return m[1];
        const params = new URLSearchParams(window.location.search);
        return params.get("job_id");
      }

      function buildRanges(text, quote, findingId) {
        const ranges = [];
        if (!quote) return ranges;
        const t = String(text || "");
        const q = String(quote || "").trim();
        if (!q || q.length < 5) return ranges; // Too short
        // Try exact match first (backend sends normalized text)
        let start = 0;
        while (true) {
          const idx = t.indexOf(q, start);
          if (idx !== -1) {
            ranges.push({ start: idx, end: idx + q.length, id: findingId });
            start = idx + Math.max(1, q.length);
            continue;
          }
          // If exact match fails, try case-insensitive match
          const tLower = t.toLowerCase();
          const qLower = q.toLowerCase();
          const idxLower = tLower.indexOf(qLower, start);
          if (idxLower !== -1) {
            ranges.push({ start: idxLower, end: idxLower + q.length, id: findingId });
            start = idxLower + Math.max(1, q.length);
            continue;
          }
          break;
        }
        return ranges;
      }

      function renderParagraph(text, ranges) {
        if (!ranges.length) return escapeHtml(text);
        const sorted = ranges.sort((a, b) => a.start - b.start);
        let out = "";
        let cursor = 0;
        for (const r of sorted) {
          if (r.start < cursor) continue;
          out += escapeHtml(text.slice(cursor, r.start));
          out += `<span class="hl" data-finding-id="${r.id}">${escapeHtml(text.slice(r.start, r.end))}</span>`;
          cursor = r.end;
        }
        out += escapeHtml(text.slice(cursor));
        return out;
      }

      function renderDetails(f) {
        const box = document.getElementById("detailBox");
        if (!box) return;
        if (!f) {
          box.innerHTML = "<div class=\"muted\">No clause selected.</div>";
          return;
        }
        const refs = (f.legal_references || []).map(r => `<li>${escapeHtml(r)}</li>`).join("");
        box.innerHTML = `
          <div class="detail-field">
            <div class="label">Explanation (UK law)</div>
            <div>${escapeHtml(f.explanation || "")}</div>
          </div>
          <div class="detail-field">
            <div class="label">Legal references</div>
            <ul>${refs || "<li>(none)</li>"}</ul>
          </div>
          <div class="detail-field">
            <div class="label">Possible consequences</div>
            <div>${escapeHtml(f.possible_consequences || "")}</div>
          </div>
          <div class="detail-field">
            <div class="label">Severity of consequences (0–3)</div>
            <div>${escapeHtml(f.risk_assessment?.severity_of_consequences ?? "")}</div>
          </div>
          <div class="detail-field">
            <div class="label">Consequences category</div>
            <div>${escapeHtml(f.consequences_category || "")}</div>
          </div>
          <div class="detail-field">
            <div class="label">Risk category</div>
            <div>${escapeHtml(f.risk_category || "")}</div>
          </div>
          <div class="detail-field">
            <div class="label">Revised clause</div>
            <div style="white-space: pre-wrap;">${escapeHtml(f.revised_clause || "")}</div>
          </div>
          <div class="detail-field">
            <div class="label">Revision explanation</div>
            <div>${escapeHtml(f.revision_explanation || "")}</div>
          </div>
          <div class="detail-field">
            <div class="label">Suggested Follow-Up for Tenant</div>
            <div>${escapeHtml(f.suggested_follow_up || "")}</div>
          </div>
        `;
      }

      async function init() {
        const status = document.getElementById("status");
        const docBox = document.getElementById("docBox");
        const jobId = getJobId();
        if (!jobId) {
          status.textContent = "Missing job_id.";
          return;
        }
        try {
          const res = await fetch(`/job/${jobId}/annotated-data`, { credentials: "same-origin" });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "Failed to load");

          const findings = data.findings || [];
          const findingsById = {};
          for (const f of findings) {
            findingsById[f.finding_id] = f;
          }
          status.textContent = findings.length
            ? `Highlighting ${findings.length} clause(s).`
            : "No unfair clauses found.";

          const paraMap = {};
          for (const f of findings) {
            const idx = f.location?.paragraph_index;
            if (idx == null) continue;
            paraMap[idx] = paraMap[idx] || [];
            paraMap[idx].push(f);
          }

          docBox.innerHTML = "";
          for (const p of data.paragraphs || []) {
            const paraEl = document.createElement("div");
            paraEl.className = "para";
            const localFindings = paraMap[p.paragraph_index] || [];
            const ranges = [];
            for (const f of localFindings) {
              ranges.push(...buildRanges(p.text || "", f.evidence_quote || "", f.finding_id));
            }
            paraEl.innerHTML = renderParagraph(p.text || "", ranges);
            docBox.appendChild(paraEl);
          }

          let currentHighlightIndex = -1;
          const allHighlights = Array.from(docBox.querySelectorAll(".hl"));
          
          function showHighlight(index) {
            if (index < 0 || index >= allHighlights.length) return;
            allHighlights.forEach(h => h.classList.remove("active"));
            const hl = allHighlights[index];
            hl.classList.add("active");
            const fid = hl.getAttribute("data-finding-id");
            renderDetails(findingsById[fid]);
            hl.scrollIntoView({ behavior: "smooth", block: "center" });
            currentHighlightIndex = index;
            const nextBtn = document.getElementById("nextClauseBtn");
            if (nextBtn) {
              nextBtn.style.display = allHighlights.length > 1 ? "inline-block" : "none";
              nextBtn.textContent = index < allHighlights.length - 1
                ? `Next unfair clause (${index + 1}/${allHighlights.length}) →`
                : `← Previous unfair clause (${index + 1}/${allHighlights.length})`;
            }
          }

          docBox.addEventListener("click", (e) => {
            const t = e.target;
            if (t && t.classList.contains("hl")) {
              const idx = allHighlights.indexOf(t);
              if (idx !== -1) {
                showHighlight(idx);
              }
            }
          });

          const nextBtn = document.getElementById("nextClauseBtn");
          if (nextBtn && allHighlights.length > 0) {
            nextBtn.addEventListener("click", () => {
              const nextIdx = (currentHighlightIndex + 1) % allHighlights.length;
              showHighlight(nextIdx);
            });
            if (allHighlights.length > 1) {
              nextBtn.style.display = "inline-block";
              showHighlight(0);
            }
          }
        } catch (e) {
          status.textContent = `Failed to load: ${String(e)}`;
        }
      }

      init();
    </script>
    <footer class="ai-disclaimer" role="contentinfo">
      AI can make mistakes. Consider checking important information.
    </footer>
  </body>
</html>
